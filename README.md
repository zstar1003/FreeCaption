# 拼字幕-长图拼接助手

一个微信小程序工具，用于拼接多张图片的字幕区域，生成长图。

扫码访问：

<div align="center">
  <img src="Assets\mini_program.png"  alt="LOGO">
</div>

## 功能特点

- 📸 支持上传多张图片（无数量限制）
- 🔒 自动内容安全检测，过滤违规图片
- 🎬 第一张图片作为完整封面
- ✂️ 后续图片只截取字幕部分进行拼接
- 📏 可自定义字幕高度（50-500px）
- 🔄 支持顶部/底部字幕裁剪
- 💾 一键保存到相册
- 📱 支持长按图片预览

## 使用方法

### 1. 开发环境准备

- 安装微信开发者工具
- Node.js 环境（用于 TypeScript 编译）
- 开通微信云开发服务

### 2. 云开发配置

**重要：本小程序使用内容安全检测功能，需要先配置云开发环境**

1. 登录[微信小程序后台](https://mp.weixin.qq.com/)，开通云开发服务
2. 在微信开发者工具中，右键点击 `cloudfunctions/imgSecCheck` 文件夹
3. 选择「上传并部署：云端安装依赖」
4. 等待云函数部署完成

详细配置说明请查看 [SECURITY_CONFIG.md](./SECURITY_CONFIG.md)

### 3. 项目运行

```bash
# 安装依赖
npm install
```

### 4. 使用流程

1. **添加图片**

   - 点击"添加图片"按钮选择图片
   - 系统会自动检测图片内容安全性
   - 违规图片会被自动过滤，并提示用户
   - 第一张图片会作为封面完整显示
   - 后续图片只会截取字幕区域
2. **设置参数**

   - 调整字幕高度滑块，设置要截取的字幕高度
   - 选择裁剪位置（顶部或底部）
3. **生成长图**

   - 至少添加2张图片后，"生成长图"按钮会激活
   - 点击按钮生成拼接后的长图
   - 自动跳转到预览页面
4. **保存图片**

   - 在预览页面长按图片可以保存
   - 或点击"保存到相册"按钮
   - 首次需要授权相册访问权限

## 项目结构

```
FreeCaption/
├── miniprogram/
│   ├── pages/
│   │   ├── index/              # 主页面（图片上传和设置）
│   │   │   ├── index.wxml      # 页面结构
│   │   │   ├── index.wxss      # 页面样式
│   │   │   ├── index.ts        # 页面逻辑
│   │   │   └── index.json      # 页面配置
│   │   ├── preview/            # 预览页面
│   │   │   ├── preview.wxml
│   │   │   ├── preview.wxss
│   │   │   ├── preview.ts
│   │   │   └── preview.json
│   ├── app.ts                  # 小程序入口
│   ├── app.wxss                # 全局样式
│   └── app.json                # 小程序配置
├── cloudfunctions/             # 云函数目录
│   └── imgSecCheck/            # 图片内容安全检测云函数
│       ├── index.js            # 云函数代码
│       ├── config.json         # 云函数配置
│       └── package.json        # 依赖配置
├── project.config.json         # 项目配置
├── SECURITY_CONFIG.md          # 内容安全配置说明
└── README.md                   # 项目说明
```

## 核心实现

### 图片拼接原理

1. 获取所有图片的尺寸信息
2. 创建 Canvas，计算总高度：
   - 第一张图片完整高度
   - 其他图片各自的字幕高度
3. 在 Canvas 上依次绘制：
   - 第一张完整图片
   - 后续图片裁剪的字幕部分
4. 导出 Canvas 为临时图片文件

### Canvas 使用

项目同时支持新旧两版 Canvas API：

- **type="2d"**: 新版 Canvas 2D API（推荐）
- **canvas-id**: 旧版 Canvas API（兼容）

## 技术栈

- 微信小程序框架
- TypeScript
- Canvas API
- 微信云开发（内容安全检测）
- 微信小程序 API（图片选择、保存相册等）

## 注意事项

1. **云开发配置**：首次使用需要开通云开发服务并部署云函数
2. **内容安全**：上传的图片会自动进行内容安全检测，违规图片会被拒绝
3. **图片大小**：建议上传的图片宽度一致，效果更好
4. **字幕高度**：根据实际字幕区域调整高度参数
5. **性能**：一次处理过多或过大的图片可能导致内存不足
6. **权限**：保存图片需要用户授权相册访问权限

## 常见问题

**Q: 为什么我的图片被拒绝了？**
A: 图片可能包含违规内容，系统会自动过滤。请确保上传的图片符合微信小程序运营规范。

**Q: 云函数部署失败怎么办？**
A: 确保已开通云开发服务，并在微信开发者工具中正确上传云函数。详见 [SECURITY_CONFIG.md](./SECURITY_CONFIG.md)

**Q: 为什么生成的长图模糊？**
A: 尝试在选择图片时选择"原图"，避免压缩。

**Q: 能否支持更多图片？**
A: 小程序支持无限数量的图片拼接。虽然微信单次最多选择9张，但可以多次添加。注意图片过多可能影响性能。

**Q: 字幕位置不准确怎么办？**
A: 调整"字幕高度"参数，或切换"裁剪位置"选项。
