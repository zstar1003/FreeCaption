# 内容安全检测配置说明

本项目已集成微信小程序内容安全检测功能，用于过滤违法、违规等不当图片内容。

## 功能说明

- **自动检测**：用户上传图片时自动调用内容安全检测接口
- **智能压缩**：超过 500KB 的图片会自动压缩后再检测，提升检测速度
- **智能过滤**：检测到违规图片会自动过滤，只添加合规图片
- **友好提示**：检测到违规内容时会提示用户，不会影响正常使用体验
- **容错处理**：检测异常或超时时默认放行，避免因网络问题影响用户体验
- **性能优化**：超大图片（>5MB）会跳过检测，避免超时

## 配置步骤

### 1. 开通云开发

1. 登录[微信小程序后台](https://mp.weixin.qq.com/)
2. 进入「云开发」菜单
3. 开通云开发服务（如果未开通）
4. 创建云开发环境（或使用已有环境）

### 2. 部署云函数

1. 打开微信开发者工具
2. 在左侧文件树中找到 `cloudfunctions` 目录
3. 右键点击 `imgSecCheck` 文件夹
4. 选择「上传并部署：云端安装依赖」
5. 等待部署完成

### 3. 配置云环境ID（可选）

如果有多个云环境，可以在 `miniprogram/app.ts` 中指定环境ID：

```typescript
wx.cloud.init({
  env: 'your-env-id', // 填入你的云环境ID
  traceUser: true,
})
```

如不指定，将使用默认环境（第一个创建的环境）。

### 4. 测试功能

1. 运行小程序
2. 尝试上传图片
3. 观察控制台输出，确认安全检测功能正常工作

## 技术实现

### 云函数
- **位置**：`cloudfunctions/imgSecCheck/`
- **接口**：使用微信官方 `security.imgSecCheck` 接口
- **返回**：`{ success: boolean, errCode: number, errMsg: string }`

### 客户端调用
- **位置**：`miniprogram/pages/index/index.ts`
- **方法**：`checkImageSecurity(imagePath: string)`
- **流程**：
  1. 读取图片为 base64 格式
  2. 调用云函数进行检测
  3. 根据检测结果过滤违规图片
  4. 提示用户检测结果

## 注意事项

1. **云开发依赖**：需要开通微信云开发服务
2. **基础库版本**：需要微信小程序基础库 2.2.3 或以上
3. **图片格式**：支持 JPG, PNG 等常见图片格式
4. **图片大小**：
   - 建议单张图片不超过 1MB，检测速度更快
   - 超过 500KB 的图片会自动压缩后检测
   - 超过 5MB 的图片会跳过检测（避免超时）
5. **检测频率**：微信对内容安全接口有调用频率限制，请合理使用
6. **费用说明**：内容安全检测接口免费，但云函数调用有免费额度限制
7. **超时处理**：云函数调用超时设置为 60 秒，超时会自动放行

## 故障排查

### 问题 1：云函数调用超时 (-404012)

**症状**：
```
cloud.callFunction:fail -404012 polling exceed max timeout retry
```

**原因**：
- 图片文件过大
- 云函数未正确部署
- 云函数冷启动时间过长

**解决方案**：
1. **检查图片大小**：
   - 查看控制台日志中的图片大小
   - 如果图片过大，会自动压缩或跳过检测

2. **重新部署云函数**：
   - 右键 `cloudfunctions/imgSecCheck` 文件夹
   - 选择「上传并部署：云端安装依赖」
   - 等待部署完成

3. **检查云函数日志**：
   - 在微信开发者工具中点击「云开发」
   - 进入「云函数」→「日志」
   - 查看是否有错误信息

4. **测试云函数**：
   - 在云函数列表中找到 `imgSecCheck`
   - 点击「测试」按钮
   - 输入测试数据（小的 base64 图片）
   - 查看是否能正常返回

### 问题 2：选择云环境错误

**症状**：
```
Error: 请在编辑器云函数根目录（cloudfunctionRoot）选择一个云环境
```

**解决方案**：
1. 在微信开发者工具顶部点击「云开发」
2. 确保已创建云环境（如未创建则创建一个）
3. 在左侧文件树 `cloudfunctions` 文件夹上右键
4. 选择「更多设置」→ 选择云环境
5. 重新上传云函数

### 问题 3：图片检测失败但无明确错误

**解决方案**：
1. **查看控制台日志**：
   - 打开开发者工具控制台
   - 查看详细的错误信息和图片大小

2. **检查云函数权限**：
   - 确认 `cloudfunctions/imgSecCheck/config.json` 包含正确的权限配置
   - 权限配置：`"openapi": ["security.imgSecCheck"]`

3. **验证云环境**：
   - 确保 `app.ts` 中云开发初始化成功
   - 查看控制台是否有"云开发环境初始化成功"日志

### 问题 4：图片检测太慢

**优化建议**：
1. 在 `wx.chooseImage` 中使用 `compressed` 而非 `original`
2. 确保网络环境良好
3. 第一次调用会有冷启动，后续会快很多
4. 可以考虑只检测第一张图片，其他图片跳过检测

## 错误处理

- **errCode 0**：检测通过，内容安全
- **errCode 87014**：内容违规，图片被拒绝
- **其他错误**：检测异常，默认放行（可在云函数中调整策略）

## 相关文档

- [微信云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [内容安全检测API](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/open/openapi/security/Cloud.openapi.security.imgSecCheck.html)
- [小程序运营规范](https://developers.weixin.qq.com/miniprogram/product/service.html)
