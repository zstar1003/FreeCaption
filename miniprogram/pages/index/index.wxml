<!-- index.wxml -->
<view class="container">
  <scroll-view scroll-y="true" class="main-content">
    <!-- 标题区 -->
    <view class="header">
      <text class="title">拼字幕工具</text>
      <text class="subtitle">上传图片，自动拼接字幕区域</text>
    </view>

    <!-- 图片列表区 -->
    <view class="image-section">
      <view class="section-title">
        <text>已选图片 ({{images.length}}/9)</text>
        <text class="tip">第一张为封面</text>
      </view>

      <view class="image-list">
        <block wx:for="{{images}}" wx:key="index">
          <view class="image-item">
            <image src="{{item}}" mode="aspectFill" class="preview-img"></image>
            <view class="image-badge">{{index === 0 ? '封面' : index}}</view>
            <view class="delete-btn" bindtap="deleteImage" data-index="{{index}}">
              <text>✕</text>
            </view>
          </view>
        </block>

        <view class="add-image-btn" bindtap="chooseImages" wx:if="{{images.length < 9}}">
          <text class="add-icon">+</text>
          <text class="add-text">添加图片</text>
        </view>
      </view>
    </view>

    <!-- 参数设置区 -->
    <view class="settings-section">
      <view class="section-title">
        <text>封面裁切设置</text>
      </view>

      <view class="setting-item">
        <view class="setting-label">
          <text>封面底部边界</text>
          <text class="setting-value" bindtap="onClickCoverBottom">{{coverBottom}}px</text>
        </view>
        <slider
          min="0"
          max="{{coverHeight || 500}}"
          value="{{coverBottom}}"
          bindchange="onCoverBottomChange"
          bindchanging="onCoverBottomChanging"
          activeColor="#667eea"
          backgroundColor="#e0e0e0"
          block-size="24"
        />
      </view>

      <view class="subtitle-height-info">
        <text>裁切高度：{{coverBottom > 0 ? coverBottom : coverHeight}}px{{coverBottom < coverHeight ? '（已裁切 ' + (coverHeight - coverBottom) + 'px）' : '（不裁切）'}}</text>
      </view>
    </view>

    <!-- 封面预览区域 -->
    <view class="preview-section" wx:if="{{coverImage}}">
      <view class="section-title">
        <text>封面预览</text>
        <text class="tip">第一张图片</text>
      </view>

      <view class="preview-container">
        <image src="{{coverImage}}" mode="widthFix" class="preview-ref-img"></image>
        <view class="preview-line preview-line-bottom" style="top: {{coverBottom / coverHeight * 100}}%"></view>
        <view class="preview-mask preview-mask-bottom" style="top: {{coverBottom / coverHeight * 100}}%; height: {{(coverHeight - coverBottom) / coverHeight * 100}}%"></view>
      </view>
    </view>

    <!-- 字幕参数设置区 -->
    <view class="settings-section">
      <view class="section-title">
        <text>字幕边界设置</text>
      </view>

      <view class="setting-item">
        <view class="setting-label">
          <text>上边界</text>
          <text class="setting-value" bindtap="onClickSubtitleTop">{{subtitleTop}}px</text>
        </view>
        <slider
          min="0"
          max="{{previewHeight || 500}}"
          value="{{subtitleTop}}"
          bindchange="onSubtitleTopChange"
          bindchanging="onSubtitleTopChanging"
          activeColor="#667eea"
          backgroundColor="#e0e0e0"
          block-size="24"
        />
      </view>

      <view class="setting-item">
        <view class="setting-label">
          <text>下边界</text>
          <text class="setting-value" bindtap="onClickSubtitleBottom">{{subtitleBottom}}px</text>
        </view>
        <slider
          min="0"
          max="{{previewHeight || 500}}"
          value="{{subtitleBottom}}"
          bindchange="onSubtitleBottomChange"
          bindchanging="onSubtitleBottomChanging"
          activeColor="#667eea"
          backgroundColor="#e0e0e0"
          block-size="24"
        />
      </view>

      <view class="subtitle-height-info">
        <text>字幕高度：{{subtitleBottom - subtitleTop}}px</text>
      </view>
    </view>

    <!-- 预览参考图区域 -->
    <view class="preview-section" wx:if="{{previewImage}}">
      <view class="section-title">
        <text>字幕预览</text>
        <text class="tip">第二张图片</text>
      </view>

      <view class="preview-container">
        <image src="{{previewImage}}" mode="widthFix" class="preview-ref-img"></image>
        <view class="preview-line preview-line-top" style="top: {{subtitleTop / previewHeight * 100}}%"></view>
        <view class="preview-line preview-line-bottom" style="top: {{subtitleBottom / previewHeight * 100}}%"></view>
        <view class="preview-mask preview-mask-top" style="height: {{subtitleTop / previewHeight * 100}}%"></view>
        <view class="preview-mask preview-mask-bottom" style="top: {{subtitleBottom / previewHeight * 100}}%; height: {{(previewHeight - subtitleBottom) / previewHeight * 100}}%"></view>
      </view>
    </view>
  </scroll-view>

  <!-- 底部操作栏 -->
  <view class="bottom-bar">
    <button class="action-btn secondary" bindtap="clearAll" wx:if="{{images.length > 0}}">
      清空
    </button>
    <button
      class="action-btn primary {{images.length < 2 ? 'disabled' : ''}}"
      bindtap="generateLongImage"
      disabled="{{images.length < 2 || processing}}"
    >
      {{processing ? '生成中...' : '生成长图'}}
    </button>
  </view>

  <!-- 隐藏的 Canvas 用于生成图片 -->
  <canvas
    canvas-id="myCanvas"
    id="myCanvas"
    style="width: {{canvasWidth}}px; height: {{canvasHeight}}px; position: fixed; left: -9999px; top: -9999px;"
  ></canvas>
</view>
